#!/bin/sh -e
#
# Runs io.elementary.capnet-assist helper on walled garden networks.
# See NetworkManager(8) for further documentation of the dispatcher events.

msg() {
    if [ -n "$(command -v logger)" ]; then
        logger -s -t io.elementary.capnet-assist $@ || :
    fi
}

wait_for_process() {
    local process="$1"
    # timeout after 90 seconds
    for t in $(seq 1 30); do
        [ -z "$(pgrep "$process")" ] || return
        sleep 3;
    done
    exit 1
}

start_browser() {
    local user="$1"
    local display="$2"

    # wait for the GUI to come up
    wait_for_process gnome-session

    export DISPLAY="$display"

    msg -p user.notice "starting browser for user: '$user', with display: '$display'"
    runuser -u "$user" -- io.elementary.capnet-assist 2>/dev/null || \
    msg -p user.err "browser failed for user: '$user', with display: '$display'"
}

[ "$2" = "connectivity-change" -a "$CONNECTIVITY_STATE" = "portal" ] || exit 0

msg -p user.debug "captive portal detected"

# Match 2nd column of who's output with ' :[at least one digit] '
who | awk '$2 ~ /:[0-9]+/ { print $1 " " $2; };' | \
while read -r user display; do
    start_browser "$user" "$display"
done
